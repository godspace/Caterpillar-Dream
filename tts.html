<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Terminal Reader // EDITOR vs AI</title>
    <script src="dialogue.js"></script>
    <style>
        :root {
            --bg-color: #080808;
            --terminal-color: #ffb000; 
            --text-color: var(--terminal-color); 
            --editor-color: #00d2ff;
            --ai-color: #ff3333;
            --font-stack: 'Courier New', 'Roboto Mono', Consolas, monospace;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: var(--font-stack);
            margin: 0;
            padding: 10px;
            height: 100dvh; 
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            overflow: hidden; 
        }

        #terminal-container {
            flex-grow: 1;
            min-height: 0; 
            border: 1px solid var(--text-color);
            padding: 15px;
            overflow-y: auto;
            background-color: rgba(0,0,0,0.6);
            box-shadow: inset 0 0 10px rgba(var(--terminal-color), 0.1);
            display: flex;
            flex-direction: column;
            font-size: 14px;
        }

        #terminal-container::-webkit-scrollbar { width: 4px; }
        #terminal-container::-webkit-scrollbar-track { background: var(--bg-color); }
        #terminal-container::-webkit-scrollbar-thumb { background: var(--text-color); }

        .history-line {
            margin-bottom: 10px;
            line-height: 1.4;
            opacity: 0.6;
        }

        .current-line-container {
            margin-top: 15px;
            margin-bottom: 15px;
            font-size: 1.1em;
            font-weight: bold;
            text-shadow: 0 0 2px var(--text-color);
            min-height: 1.4em;
        }

        .role-prefix { font-weight: bold; margin-right: 8px; letter-spacing: 0.5px; }
        .role-editor { color: var(--editor-color); text-shadow: 0 0 4px var(--editor-color); }
        .role-ai { color: var(--ai-color); text-shadow: 0 0 4px var(--ai-color); }

        .cursor {
            display: inline-block;
            width: 8px;
            height: 1.1em;
            background-color: var(--text-color);
            animation: blink 1s step-end infinite;
            vertical-align: text-bottom;
            margin-left: 2px;
        }
        @keyframes blink { 50% { opacity: 0; } }

        .bottom-panel {
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            padding-top: 15px;
        }

        .controls {
            display: flex;
            gap: 8px;
            justify-content: space-between;
        }

        .btn-terminal {
            flex: 1; 
            background: transparent;
            border: 1px solid var(--text-color);
            color: var(--text-color);
            padding: 12px 5px; 
            font-family: var(--font-stack);
            font-weight: bold;
            font-size: 14px;
            cursor: pointer;
            text-transform: uppercase;
            touch-action: manipulation; 
        }

        .btn-terminal:active {
            background: var(--text-color);
            color: var(--bg-color);
        }

        .status-bar {
            margin-top: 8px;
            font-size: 10px;
            opacity: 0.5;
            text-align: center;
        }

        @media (max-width: 400px) {
            .btn-terminal { font-size: 12px; padding: 10px 2px; }
        }
    </style>
</head>
<body>

    <div id="terminal-container">
        <div id="history-output"></div>
        <div class="current-line-container" id="current-line-block" style="display: none;">
            <span id="current-role-prefix" class="role-prefix"></span>
            <span id="current-text-content"></span><span class="cursor"></span>
        </div>
        <div id="boot-message">
            > BOOT SEQUENCE INITIATED...<br>
            > AWAITING COMMAND...
        </div>
    </div>

    <div class="bottom-panel">
        <div class="controls">
            <button id="btn-start" class="btn-terminal">[ ► EXEC ]</button>
            <button id="btn-pause" class="btn-terminal">[ ❚❚ PAUSE ]</button>
            <button id="btn-reset" class="btn-terminal">[ ■ RESET ]</button>
        </div>
        <div class="status-bar" id="status-bar">SYS.STATUS: STANDBY</div>
    </div>

    <script>
        if (typeof dialogueData === 'undefined') {
            document.getElementById('boot-message').innerHTML += "<br><span style='color:red'>> ERROR: dialogue.js MISSING.</span>";
        }

        const synth = window.speechSynthesis;
        let currentIndex = 0;
        let isPlaying = false; 
        let isPausedState = false; 
        let editorVoice = null;
        let aiVoice = null;
        let currentUtterance = null;

        let typingInterval = null;
        let currentFullText = "";
        let timeoutId = null; 

        // Заданные по умолчанию настройки
        const cfgRate = 1.0;
        const cfgPitch = 1.0;
        const cfgTypeSpeed = 60; // миллисекунды
        const cfgPing = 0;       // миллисекунды

        const ui = {
            history: document.getElementById('history-output'),
            curBlock: document.getElementById('current-line-block'),
            prefix: document.getElementById('current-role-prefix'),
            text: document.getElementById('current-text-content'),
            boot: document.getElementById('boot-message'),
            status: document.getElementById('status-bar'),
            term: document.getElementById('terminal-container'),
            btnStart: document.getElementById('btn-start')
        };

        function initVoices() {
            let voices = synth.getVoices();
            if (voices.length === 0) return;

            ui.boot.style.display = 'none';
            ui.curBlock.style.display = 'block';
            ui.text.innerText = 'СИСТЕМА ГОТОВА К ЗАПУСКУ.';
            ui.prefix.innerText = '> ';

            const ruNat = voices.filter(v => v.lang.includes('ru') && (v.name.includes('Natural') || v.name.includes('Online')));
            editorVoice = ruNat.find(v => v.name.includes('Dmitry')) || voices.find(v => v.lang.includes('ru'));
            aiVoice = ruNat.find(v => !v.name.includes('Dmitry')) || voices.find(v => v.lang.includes('ru') && v !== editorVoice) || editorVoice;
            
            ui.status.innerText = `SYS.STATUS: READY. VOICES: ${voices.length}`;
        }

        initVoices();
        if (speechSynthesis.onvoiceschanged !== undefined) speechSynthesis.onvoiceschanged = initVoices;

        function startTyping(text) {
            clearInterval(typingInterval);
            ui.text.innerText = "";
            currentFullText = text;
            let i = 0;
            typingInterval = setInterval(() => {
                if (i < text.length) {
                    ui.text.innerText += text.charAt(i);
                    i++;
                    ui.term.scrollTop = ui.term.scrollHeight;
                } else {
                    clearInterval(typingInterval);
                }
            }, cfgTypeSpeed);
        }

        function stopTyping(instantShow = false) {
            clearInterval(typingInterval);
            if (instantShow) ui.text.innerText = currentFullText;
        }

        function playDialogue(index) {
            synth.cancel();
            clearTimeout(timeoutId);
            stopTyping();

            if (index >= dialogueData.length) {
                resetState('СЕАНС ЗАВЕРШЕН.');
                return;
            }

            isPlaying = true;
            isPausedState = false;
            ui.btnStart.innerText = "[ ► EXEC ]";
            ui.status.innerText = `SYS.STATUS: RUNNING (${index + 1}/${dialogueData.length})`;

            const data = dialogueData[index];
            const isEd = data.role === 'editor';

            if (index > 0) addToHistory(dialogueData[index - 1]);
            else ui.history.innerHTML = '';

            ui.prefix.className = 'role-prefix ' + (isEd ? 'role-editor' : 'role-ai');
            ui.prefix.innerText = isEd ? 'ED_>' : 'AI_>';
            
            startTyping(data.text);
            
            currentUtterance = new SpeechSynthesisUtterance(data.text);
            currentUtterance.voice = isEd ? editorVoice : aiVoice;
            currentUtterance.rate = cfgRate;
            currentUtterance.pitch = cfgPitch;

            currentUtterance.onend = () => {
                if (isPlaying && !isPausedState) {
                    currentIndex++;
                    timeoutId = setTimeout(() => playDialogue(currentIndex), cfgPing);
                }
            };
            
            currentUtterance.onerror = (e) => {
                 if(isPlaying && !isPausedState) {
                      synth.cancel();
                      timeoutId = setTimeout(() => playDialogue(currentIndex), 1000);
                 }
            };

            synth.speak(currentUtterance);
        }

        function addToHistory(data) {
            const isEd = data.role === 'editor';
            const div = document.createElement('div');
            div.className = 'history-line';
            div.innerHTML = `<span class="role-prefix ${isEd ? 'role-editor' : 'role-ai'}">${isEd ? '[ED]>' : '[AI]>'}</span> ${data.text}`;
            ui.history.appendChild(div);
            ui.term.scrollTop = ui.term.scrollHeight;
        }

        function resetState(msg) {
            synth.cancel();
            clearTimeout(timeoutId);
            stopTyping();
            currentIndex = 0;
            isPlaying = isPausedState = false;
            ui.history.innerHTML = '';
            ui.prefix.className = 'role-prefix';
            ui.prefix.innerText = '> ';
            ui.text.innerText = msg;
            ui.status.innerText = "SYS.STATUS: STANDBY";
            ui.btnStart.innerText = "[ ► EXEC ]";
        }

        ui.btnStart.addEventListener('click', () => {
            if (isPausedState) {
                ui.status.innerText = "SYS.STATUS: RESUMING...";
                playDialogue(currentIndex);
            } else if (!isPlaying) {
                playDialogue(currentIndex);
            }
        });

        document.getElementById('btn-pause').addEventListener('click', () => {
            if (isPlaying && !isPausedState) {
                synth.cancel();
                clearTimeout(timeoutId);
                stopTyping(true);
                isPausedState = true;
                ui.status.innerText = "SYS.STATUS: *** PAUSED ***";
                ui.btnStart.innerText = "[ ► RESUME ]";
            }
        });

        document.getElementById('btn-reset').addEventListener('click', () => resetState('СБРОС. ОЖИДАНИЕ КОМАНДЫ.'));

    </script>
</body>
</html>